<html>
<head>
<meta charset="iso-8859-1"/>
<title>Regenbogen Puzzle</title>

<script>

var inner = null;
var columns = null;
var scaling = 1;

var colors = [ '#E40203', '#FE7301', '#FEED01', '#008029', '#0045E8', '#750686' ];
var startpattern = [[1,0,2,5], [3,5,4,2], [0,1,3,5], [0,3,2,0,], [2,4,1,4], [5,1,3,4] ];

var elementUnderMouse = null;
var fromColumn = 0;

function l(col,row)
{
    return (3 + col*12); 
}

function t(col,row)
{
    return (55-(row*15)); 
}

function nearestcolumn(x)
{
    return Math.max(0,Math.min(7,Math.floor((x-1.5)/12.5)))
}


function initDocument()
{
	document.body.innerHTML = ''
    
    var page = document.createElement('div');
    page.style.cssText = 'position:absolute;width:100%;height:100%';
    document.body.appendChild(page);
        
    inner = document.createElement('div');
    inner.style.cssText = 'position:absolute;width:100;height:100;top:0;left:0;opacity:1;background:#000;transform-origin:top left';
    page.appendChild(inner);

    columns = [];
    for (c=0; c<8; c++)
    {
        columns.push([]);
        
        for (r=0; c<6 && r<4; r++)
        {
            var color = colors[startpattern[c][r]];
            
            var box = document.createElement('div');
            box.style.cssText = 'position:absolute;width:10;height:15;opacity:1;z-index:1;background:'+color;
            box.style.left = l(c,r);
            box.style.top = t(c,r);
            inner.appendChild(box);
            
            columns[c].push(box);
        }
    }   
    
    updateScale();

    inner.addEventListener("mousedown", mouseDown);
    inner.addEventListener("mouseup", mouseUp);
    inner.addEventListener("mousemove", mouseMove);
    inner.addEventListener("touchstart", mouseDown);
    inner.addEventListener("touchend", mouseUp);
    inner.addEventListener("touchmove", mouseMove);
    
    window.addEventListener('resize', updateScale);
}

function mouseDown(event) 
{
    var x = event.x/scaling;
    var y = event.y/scaling;
//    console.log("mouse down",x,y);

    var c = nearestcolumn(x);
    if (elementUnderMouse==null && columns[c].length>0)
    {
        fromColumn = c;
        elementUnderMouse = columns[c].pop();
        elementUnderMouse.style["z-index"] = 2;
        dragTo(x,y)
    }
}
 
function mouseUp(event) 
{
    var x = event.x/scaling;
    var y = event.y/scaling;
    
    var c = nearestcolumn(x);
    if (elementUnderMouse!=null)
    {
        var target = fromColumn;
        var tl = columns[c].length;
        if (tl<4 && c!=fromColumn)
            if (tl<1 || columns[c][tl-1].style.background == elementUnderMouse.style.background)
        {
            target = c;
        }
        elementUnderMouse.style.left = l(target,columns[target].length);
        elementUnderMouse.style.top  = t(target,columns[target].length);        
        elementUnderMouse.style["z-index"] = 1;
        columns[target].push(elementUnderMouse); 
        elementUnderMouse = null;
    }
    
    
//    console.log("mouse up",x,y);
}

function mouseMove(event) 
{
    var x = event.x/scaling;
    var y = event.y/scaling;
//    console.log("mouse move",x,y);
    
    if (elementUnderMouse!=null)
    {
        dragTo(x,y);        
    }
}


function updateScale()
{
    var s = Math.min(window.innerWidth,window.innerHeight) / 100.0;
    inner.style.transform = "scale(" + s +")" 
    scaling = s;
}

function dragTo(x,y)
{
    elementUnderMouse.style.left = x-5;
    elementUnderMouse.style.top = y-7.5;
}

</script>

</head>
<body onload="initDocument()" style="margin:0">
</body>
</html>
